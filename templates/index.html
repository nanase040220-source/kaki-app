<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŸ¿ã®ç†Ÿåº¦åˆ¤å®šAI</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        video, img, canvas { max-width: 100%; border-radius: 8px; margin-top: 10px; }
        #camera-area, #result-area { display: none; margin-top: 20px; border: 1px solid #ddd; padding: 10px; }
        .btn { padding: 10px 20px; font-size: 16px; cursor: pointer; margin: 5px; }
        .btn-primary { background-color: #007bff; color: white; border: none; border-radius: 5px; }
        .btn-success { background-color: #28a745; color: white; border: none; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ… æŸ¿ã®ç†Ÿåº¦åˆ¤å®šAI</h1>

        <div>
            <button class="btn" onclick="openCamera()">ğŸ“· ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•</button>
            <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFileUpload(this)">
            <button class="btn" onclick="document.getElementById('fileInput').click()">ğŸ“ ç”»åƒã‚’é¸æŠ</button>
        </div>

        <div id="camera-area">
            <video id="video" autoplay playsinline></video>
            <br>
            <button class="btn btn-primary" onclick="captureAndAnalyze()">ğŸ“¸ æ’®å½±ã—ã¦åˆ¤å®š</button>
            <button class="btn" onclick="closeCamera()">é–‰ã˜ã‚‹</button>
            <canvas id="canvas" style="display: none;"></canvas>
        </div>

        <div id="result-area">
            <h2>åˆ¤å®šçµæœ</h2>
            <p id="loading-msg" style="display:none;">AIè§£æä¸­...</p>
            <div id="result-text" style="font-weight: bold; font-size: 1.2em; margin: 10px 0;"></div>
            <img id="result-image" alt="Result Image">
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const cameraArea = document.getElementById('camera-area');
        const resultArea = document.getElementById('result-area');
        let stream = null;

        // ã‚«ãƒ¡ãƒ©èµ·å‹•
        async function openCamera() {
            resultArea.style.display = 'none';
            cameraArea.style.display = 'block';
            try {
                // ã‚¹ãƒãƒ›ã®å¤–ã‚«ãƒ¡ãƒ©ã‚’å„ªå…ˆ
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" } 
                });
                video.srcObject = stream;
            } catch (err) {
                alert("ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err);
            }
        }

        // ã‚«ãƒ¡ãƒ©åœæ­¢
        function closeCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            cameraArea.style.display = 'none';
        }

        // æ’®å½±ã—ã¦APIã¸é€ä¿¡
        function captureAndAnalyze() {
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã«ç¾åœ¨ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’æç”»
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);

            // ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’Blobã¨ã—ã¦å–å¾—
            canvas.toBlob(function(blob) {
                sendToApi(blob);
                closeCamera();
            }, 'image/jpeg');
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚ã®å‡¦ç†
        function handleFileUpload(input) {
            if (input.files && input.files[0]) {
                sendToApi(input.files[0]);
            }
        }

        // APIé€ä¿¡å‡¦ç†
        async function sendToApi(imageBlob) {
            resultArea.style.display = 'block';
            document.getElementById('loading-msg').style.display = 'block';
            document.getElementById('result-text').innerText = "";
            document.getElementById('result-image').style.display = 'none';

            const formData = new FormData();
            formData.append('file', imageBlob, 'image.jpg');

            try {
                const response = await fetch('https://kaki-app.onrender.com/analyze', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                document.getElementById('loading-msg').style.display = 'none';
                
                if (data.processed_image) {
                    document.getElementById('result-image').src = data.processed_image;
                    document.getElementById('result-image').style.display = 'block';
                    document.getElementById('result-text').innerText = data.result_text;
                    document.getElementById('result-text').style.color = data.status.includes('OK') ? 'green' : 'red';
                } else {
                    document.getElementById('result-text').innerText = data.result_text || "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
                }

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading-msg').innerText = "é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
            }
        }
    </script>
</body>
</html>
